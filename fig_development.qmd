---
title: "Figure development"
subtitle: "What happens when an important coastal fishery collapses in a rural state"
author: "cslovas"
format: 
  html:
    toc: true
    self-contained: true
editor: visual
---
Consolidating outputs from various different scripts to compile different iterations of figures intended for objective 1 paper

```{r}
#| label: data dependencies
#| echo: false
#| message: false
#| warning: false

library(tidyverse)
library(readr)
library(gmRi)

# All license types
## species portfolio
license_portfolio      <- read_rds("Data/clean_portfolio.rds")
## time series (count)
license_time_series    <- read_rds("R/maine/license_time_series.rds")
## annual_metrics
license_metrics_series <- read_rds("R/maine/license_metrics_series.rds")

# Target species
## species_portfolio 
species_portfolio <- read_rds("R/maine/species_level_portfolio.rds")
## time series (count)
species_time_series <- read_rds("R/maine/species_time_series.rds")
## annual_metrics
species_metrics_series <- read_rds("R/maine/species_metrics_series.rds")

# Stoll et all [revised] divisions

## species portfolio
stoll_portfolio      <- read_rds("R/maine/stoll_portfolio.rds")
## time series (count)
stoll_time_series    <- read_rds("R/maine/stoll_time_series.rds")
## annual_metrics
stoll_metrics_series <- read_rds("R/maine/stoll_metrics_series.rds")
```

## Constrained hierarchical clustering
```{r}
#| label: clustering
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 5

library(dendextend)
library(rioja) #chclust()
library(vegan) #bstick()
library(factoextra) #fviz_dist()

years     <- 1990:2025
#################
# All License Types
license_portfolio %>% 
  ungroup() %>%
  select(!landings_number) %>%
  pivot_longer(cols = 2:50, names_to = "category", values_to = "count") %>% 
  filter(!count == 0) %>% 
  group_by(license_year, category) %>% 
  summarise(count = sum(count)) %>% 
  pivot_wider(names_from = "category", values_from = "count") %>% 
  arrange(license_year) %>% 
  select(!license_year) -> dend

## distance
eucdist<-vegdist(as.matrix(dend),method="euclidean",binary=FALSE,diag=FALSE,upper=FALSE,na.rm=TRUE)

## clustering
cl<-chclust(eucdist,method="coniss")

as.dendrogram(cl) %>%
  set("labels", years) %>%
  set("labels_col", value = c("#07a3b7", "#ea4f12", "#767676"), k=3) %>%
  set("branches_k_color",value = c("#07a3b7", "#ea4f12", "#767676"), k=3) %>%
  plot(main = "All license types", xlab = "Year", ylab = "Sum of squares")

#################
# Species level
species_portfolio %>% 
  ungroup() %>%
  select(!landings_number) %>%
  pivot_longer(cols = 2:20, names_to = "category", values_to = "count") %>% 
  filter(!count == 0) %>% 
  group_by(license_year, category) %>% 
  summarise(count = sum(count)) %>% 
  pivot_wider(names_from = "category", values_from = "count") %>% 
  arrange(license_year) %>% 
  select(!license_year) -> dend

## distance
eucdist<-vegdist(as.matrix(dend),method="euclidean",binary=FALSE,diag=FALSE,upper=FALSE,na.rm=TRUE)

## clustering
cl<-chclust(eucdist,method="coniss")

as.dendrogram(cl) %>%
  set("labels", years) %>%
  set("labels_col", value = c("#07a3b7", "#ea4f12", "#767676"), k=3) %>%
  set("branches_k_color",value = c("#07a3b7", "#ea4f12", "#767676"), k=3) %>%
  plot(main = "Species level license groupings", xlab = "Year", ylab = "Sum of squares")

#################
# Stoll divisions
stoll_portfolio %>% 
  ungroup() %>%
  select(!landings_number) %>%
  pivot_longer(cols = 2:27, names_to = "category", values_to = "count") %>% 
  filter(!count == 0) %>% 
  group_by(license_year, category) %>% 
  summarise(count = sum(count)) %>% 
  pivot_wider(names_from = "category", values_from = "count") %>% 
  arrange(license_year) %>% 
  select(!license_year) -> dend

## distance
eucdist<-vegdist(as.matrix(dend),method="euclidean",binary=FALSE,diag=FALSE,upper=FALSE,na.rm=TRUE)

## clustering
cl<-chclust(eucdist,method="coniss")

as.dendrogram(cl) %>%
  set("labels", years) %>%
  set("labels_col", value = c("#07a3b7", "#ea4f12", "#767676"), k=3) %>%
  set("branches_k_color",value = c("#07a3b7", "#ea4f12", "#767676"), k=3) %>%
  plot(main = "Stoll et al divisions [revised]", xlab = "Year", ylab = "Sum of squares")
```

## Heatmaps
```{r}
#| label: heatmaps
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 5

order <- c("Scallop (Dragger)",
           "Scallop (Tender)",
           "Scallop (Hand)",
           "Lobster Apprentice & Student", 
           "Lobster Class I",
           "Lobster Class II",
           "Lobster Class III",
           "Green crab",
           "Marine worm",
           "Shellfish",
           "Surf Clam",
           "Mussel",
           "Mahogany Clam",
           "Seaweed",
           "Sea Urchin (Dragger)",
           "Sea Urchin (Hand)",
           "Sea Urchin (Tender)",
           "Elver",
           "Eel",
           "Northern Shrimp",
           "Sea Cucumber",
           "Pelagic & Anadromous",
           "Commercial Fishing",
           "Aquaculture",
           "Spat",
           "Menhaden")
rev_order <- rev(order)

# All license types
license_time_series %>%
  unnest(data) %>% 
  ggplot() +
  geom_tile(aes(x = license_year, y = description, alpha = total), fill = "#00608A", color = "#FFFFFF") +
  ylab("License category") + xlab("Year") +
  ggtitle("All license types") +
  guides(alpha = guide_legend(title = "Total number issued")) +
  geom_vline(aes(xintercept = 1998), linetype = 1, color = "#07a3b7") +
  geom_vline(aes(xintercept = 2013), linetype = 1, color = "#ea4f12") +
  theme_gmri(panel.grid.major = element_blank(),
             axis.line = element_blank()) 

# Species level
species_time_series %>% 
   unnest(data) %>% 
  ggplot() +
  geom_tile(aes(x = license_year, y = species, alpha = count), fill = "#00608A", color = "#FFFFFF") +
  ylab("License category") + xlab("Year") +
  ggtitle("Species level grouping") +
  guides(alpha = guide_legend(title = "Total number issued")) +
  geom_vline(aes(xintercept = 1994), linetype = 1, color = "#07a3b7") +
  geom_vline(aes(xintercept = 2007), linetype = 1, color = "#ea4f12") +
  theme_gmri(panel.grid.major = element_blank(),
             axis.line = element_blank()) 

# Stoll divisions
stoll_time_series %>% 
   unnest(data) %>% 
  ggplot() +
  geom_tile(aes(x = license_year, y = factor(license_group, level = rev_order), alpha = total), fill = "#00608A", color = "#FFFFFF") +
  ylab("License category") + xlab("Year") +
  ggtitle("Stoll et al divisions [revised]") +
  guides(alpha = guide_legend(title = "Total number issued")) +
  geom_vline(aes(xintercept = 1999), linetype = 1, color = "#07a3b7") +
  geom_vline(aes(xintercept = 2011), linetype = 1, color = "#ea4f12") +
  theme_gmri(panel.grid.major = element_blank(),
             axis.line = element_blank()) 
```

## Network Metrics
### Degree centrality
Stoll divisions only
```{r}
#| label: degree centrality
#| echo: false
#| message: false
#| warning: false
#| fig-width: 11
#| fig-height: 8.5

# license_metrics_series %>% 
#   select(license_year, degree) %>% 
#   unnest_longer(degree) %>% 
#   group_by(degree_id) %>%
#   rename("license_group" = "degree_id") %>% 
#   mutate(level = "all_licenses") -> licenses_degree
# 
# species_metrics_series %>% 
#   select(license_year, degree) %>% 
#   unnest_longer(degree) %>% 
#   group_by(degree_id) %>%
#   rename("license_group" = "degree_id") %>% 
#   mutate(level = "species_level") -> species_degree

stoll_metrics_series %>% 
  select(license_year, degree) %>% 
  unnest_longer(degree) %>% 
  group_by(degree_id) %>%
  rename("license_group" = "degree_id") %>% 
  mutate(level = "stoll_divisions") -> stoll_degree

ggplot(data = stoll_degree) +
  geom_line(aes(x = license_year, y = degree, color = factor(license_group, levels = order))) + 
  scale_color_gmri() +
  xlab("Year") + ylab("Degree centrality") + ggtitle("Stoll et al divisions") +
  theme_gmri(legend.position = "bottom") +
  guides(color = guide_legend(title = "License category", nrow = 4))
  

```

### Edge density and modularity
```{r}
#| label: density and modularity
#| echo: false
#| message: false
#| warning: false
#| fig-width: 11
#| fig-height: 8.5

license_metrics_series %>% 
  select(license_year, density, modularity) %>%
  mutate(density = as.numeric(density),
         modularity = as.numeric(modularity),
         level = "all_licenses") %>% 
  full_join(species_metrics_series %>%
              select(license_year, density, modularity) %>%
              mutate(level = "species_level")) %>% 
  full_join(stoll_metrics_series %>%
              select(license_year, density, modularity) %>%
              mutate(level = "stoll")) -> dens_mod

ggplot(data = dens_mod) +
  geom_line(aes(x = license_year, y = density, color = level)) +
  theme_gmri(axis.text  = element_text(size = 8),
                 panel.border = element_rect(color = "black", linetype = 1),
                 panel.grid.major = element_line(color = "#e9e9e9", linetype = 1),
                 panel.grid.minor = element_line(color = "#e9e9e9", linetype = 1)) +
  scale_color_gmri() +
  xlab("Year") + ylab("Edge density") + ggtitle("Edge Density") 

ggplot(data = dens_mod) +
  geom_line(aes(x = license_year, y = modularity, color = level)) +
  theme_gmri(axis.text  = element_text(size = 8),
                 panel.border = element_rect(color = "black", linetype = 1),
                 panel.grid.major = element_line(color = "#e9e9e9", linetype = 1),
                 panel.grid.minor = element_line(color = "#e9e9e9", linetype = 1)) +
  scale_color_gmri() +
  xlab("Year") + ylab("Modularity") + ggtitle("Modularity") 


```

