---
title: "Anomalies"
author: "cslovas"
format: 
  html:
    toc: true
    self-contained: true
editor: visual
---

```{r}
#| label:   load libraries & data
#| echo:    false
#| message: false
#| warning: false

# Install & load the libraries
library(tidyverse)
library(tidygraph)
library(ggraph)
library(igraph)
library(here)
library(gmRi)
library(grid)
library(gt)

# Read in gomfish package from Joshua and Theresa
devtools::install_github("Social-Oceans-Lab/gomfish")
library(gomfish)

data(ind_lic_portfolio) 

ind_lic_portfolio <- ind_lic_portfolio %>% filter(!license_year == 2022) # unreliable

# Read in updated license codes 
updated_license_codes <- read.csv(here("Data", "updated_license_codes.csv")) %>%
  rename("license_type" = "code")

# Remove indigenous and non-harvester licenses
license_types <- names(ind_lic_portfolio %>%
                         select(!c(landings_number, license_year)))
license_types <- as_tibble(license_types) %>%
  rename("license_type" = "value") %>%
  left_join(updated_license_codes) %>%
  mutate(description = str_to_sentence(description))

license_types %>%
  filter(!group %in% c("Demo","Post-Harvest", "Non-resident", "Recreational")) %>%
  filter(!(str_starts(license_type, "ma"))) %>%
  filter(!(str_starts(license_type, "mi"))) %>%
  filter(!(str_starts(license_type, "nb"))) %>%
  filter(!(str_starts(license_type, "p")))  %>%
  filter(!license_type %in% c("st", "sts", "csw", "csws", "fhc", "lnc", "mws", "mw", "nfhc", "nfhs", "vh")) %>%
  drop_na() -> license_types # the one NA here is sut 
```

# Assessing Data Anomalies

## Commercial finfish licenses
*cfs, cfc, cps, cpc*

```{r}
#| label: commercial licenses
#| echo: false
#| message: false
#| warning: false
#| fig-width: 8
#| fig-height: 6
#| fig-align: center

ind_lic_portfolio %>% 
  select(license_year, landings_number, cfc, cfs, cpc, cps) %>%
  pivot_longer(col = cfc:cps, names_to = "license", values_to = "count") %>%
  filter(!count == 0) %>%
  group_by(license_year, license) %>%
  nest() %>% 
  mutate(total       = map_dbl(data, function(x){sum(x$count)}),
         individuals = map_dbl(data, function(x){nrow(x)})) -> anomalies
  
ggplot(anomalies) +
  geom_col(aes(x = license_year, y = individuals, fill = license)) +
  theme_gmri()+#plot.title = element_text(size = 10),
             #axis.text  = element_text(size = 8),
             #axis.title = element_text(size = 8)) +
  scale_fill_gmri() +
  xlab("Year") + ylab("Total Number of Individuals") + ggtitle("Total number of individual license holders")

```
There's a spike in *cfs* in 1995. Let's examine that. 
```{r}
#| label: 1995 commercial finfish
#| echo: false
#| message: false

ind_lic_portfolio %>%
  select(license_year, landings_number, cfs) %>%
  filter(!cfs == 0) -> cfs_1995
  
cfs_1995 %>%
  group_by(license_year) %>%
  summarise(count = sum(cfs)) %>%
  ggplot() +
  geom_line(aes(x = license_year, y = count)) +
  xlab("Year") + ylab("Count") +
  ggtitle("Commercial Fisheries Single") +
  theme_gmri()

ind_lic_portfolio %>%
  select(license_year, landings_number, cfs) %>%
  filter(!cfs == 0) %>%
  group_by(landings_number) %>%
  summarise(count = sum(cfs)) %>%
  filter(count == 1) -> cfs_once

cfs_1995 %>% 
  filter(license_year == 1995) %>%
  filter(landings_number %in% cfs_once$landings_number) -> cfs_once

```

4,438 individuals held the *cfs* license only once in the thirty year dataset. Of the 2,404 individuals licensed in 1995, 54% (1,309) are one-time license holders.

```{r}
#| label: examing individuals
#| echo: false

ind_lic_portfolio %>%
  filter(landings_number %in% cfs_once$landings_number) %>%
  pivot_longer(cols = 3:147, names_to = "license_type", values_to = "count") %>%
  filter(!count == 0) %>%
  filter(license_type %in% license_types$license_type) -> cfs_portfolio

ggplot(cfs_portfolio) +
  geom_col(aes(x = license_year, y=count, fill = license_type), position = "stack") +
  theme_gmri(legend.position = "right") +
  scale_fill_viridis_d() +
  ggtitle("Portfolios of one-time cfs license holders")

```
I'm not convinced that this is an issue with data, at least on our end. Was this reactive or proactive to a policy change? Someone who knows this better might be able to answer. 

