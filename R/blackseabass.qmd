---
title: "Black sea bass"
author: "cslovas"
format: 
  html:
    toc: true
    self-contained: true
editor: visual
---

## What is happening with black sea bass?

![](images/bsb.png){fig-align="left" width="134"} 

Pulling together bottom trawl survey data, federal landings, and federal license data, here we explore black sea bass access and exploitation.

#### Helpful information on black sea bass (*Centropristis striata*)

-   [Atlantic States Marine Fisheries Commission](https://www.asmfc.org/species/black-sea-bass)
-   [NOAA Fisheries](https://www.fisheries.noaa.gov/species/black-sea-bass)

```{r}
#| label: load data and dependencies 
#| echo: false
#| message: false
#| warning: false

library(tidyverse)
# devtools::install_github("https://github.com/gulfofmaine/gmRi")
library(gmRi)
library(here)
library(grid)
library(gomfish)
library(matrixStats)
library(rnaturalearth)

garfo_clean    <- read.csv(here("Data", "all_GARFO_data.csv"))
garfo_landings <- read.csv(here("Data", "landings.csv"))
garfo_licenses <- read.csv(here("Data", "garfo_license_list.csv"))
maine_licenses <- ind_lic_portfolio
maine_codes    <- read.csv(here("Data", "updated_license_codes.csv"))

```

```{r}
#| label: load trawl data
#| echo: false
#| message: false
#| warning: false

# Load NEFSC Bottom Trawl Survey data ####
clean_survey <- gmri_survdat_prep(
  survdat_source ="most recent",
  box_location ="cloudstorage"
)

clean_survey  <- clean_survey %>% 
  distinct(est_year, survey_area, stratum, tow, est_towdate, season, comname, catchsex, .keep_all = T) %>%
  filter(!season %in% c("Summer", "Winter") & est_year >= 1970) %>%
  group_by(est_year, survey_area, stratum, tow, est_towdate, season, 
           avgdepth, surftemp, bottemp, decdeg_beglat, decdeg_beglon, comname, abundance) %>% 
  summarise(biomass_kg = sum(biomass_kg, na.rm = T), .groups = "drop") 

# Weight by biomass
grouped_center_bio <- function(clean_survey, ...){
  clean_survey %>% 
    group_by(comname, ...) %>% 
    summarise(
      # Un-weighted averages
      total_biomass   = sum(biomass_kg),
      avg_biomass     = mean(biomass_kg),
      biomass_sd      = sd(biomass_kg),
      # All below are weighted by biomass
      avg_depth       = weightedMean(avgdepth, w = biomass_kg, na.rm = T),
      avg_bot_temp    = weightedMean(bottemp, w = biomass_kg, na.rm = T),
      avg_sur_temp    = weightedMean(surftemp, w = biomass_kg, na.rm = T),
      avg_lat         = weightedMean(decdeg_beglat, w = biomass_kg, na.rm = T),
      avg_lon         = weightedMean(decdeg_beglon, w = biomass_kg, na.rm = T),
      depth_sd        = weightedSd(avgdepth, w = biomass_kg, na.rm = T),
      temp_sd         = weightedSd(bottemp, w = biomass_kg, na.rm = T),
      lat_sd          = weightedSd(decdeg_beglat, w = biomass_kg, na.rm = T),
      lon_sd          = weightedSd(decdeg_beglon, w = biomass_kg, na.rm = T),
      .groups = "drop") 
}

weighted_data <- grouped_center_bio(clean_survey, est_year, season) %>%
  mutate(decade = 10*est_year %/% 10)
```

```{r}
#| label: bsb
#| echo: false
#| warning: false
#| message: false
#| fig-align: center

biomass <- weighted_data %>% 
  filter(comname == "black sea bass" & est_year >= 1970 & !season %in% c("Winter", "Summer")) 

landings <- garfo_landings %>% 
  filter(SPPNAME == "SEA BASS, BLACK" & YEAR >= 1970) %>% 
  select(PORT.NAME, STATE, YEAR, LANDED.LBS, VALUE) %>% 
  mutate(LANDED.LBS = parse_number(LANDED.LBS),
         VALUE = parse_number(VALUE))

fed_license <- garfo_clean %>% 
  pivot_longer(cols = BLACK_SEA_BASS_1:TILEFISH_D, names_to = "license", values_to = "count") %>% 
  filter(!count == 0 & license == "BLACK_SEA_BASS_1") 
 

me_license <- maine_licenses %>% 
  select(landings_number, license_year, cpc, cps) %>% 
  pivot_longer(cols = cpc:cps, names_to = "code", values_to = "count") %>%
  filter(!count == 0) %>%
  left_join(maine_codes) # in order to compare, would need state landings but I don't think those exist here...


```

## Distributions

### Average biomass and center of biomass based on NEFSC bottom trawl survey

```{r}
#| label: biomass
#| echo: false
#| message: false
#| warnging: false
#| fig-align: center

ggplot(data = biomass) +
  geom_line(aes(x = est_year, y = avg_lat, color = season)) +
  theme_gmri()+
  scale_color_gmri() +
  ggtitle("Seasonal center of biomass") +
  xlab("Year") + ylab("Biomass-weighted average latitude")

biomass %>%
  group_by(est_year) %>% 
  summarise(avg_lat = mean(avg_lat)) %>% 
  ggplot() +
  geom_line(aes(x = est_year, y = avg_lat)) + 
  geom_smooth(aes(x = est_year, y = avg_lat), method = "lm", se = FALSE, color = "#07a3b7", linetype = 2, alpha = 0.7) +
  ylab("Biomass-weighted average latitude") +
  xlab("Year") +
  ggtitle("Annual center of biomass") +
  theme_gmri()

biomass %>% 
  group_by(est_year, season) %>%
  summarise(total_biomass = sum(total_biomass)) %>% 
  ggplot()+
  geom_col(aes(x = est_year, y = total_biomass, fill = season), position = "dodge") + #fill = "#07a3b7") +
  scale_fill_gmri(palette = "main") +
  theme_gmri() +
  ggtitle("Annual surveyed biomass") +
  ylab("Biomass (kg)") +
  xlab("Year")

biomass %>% 
  group_by(est_year) %>%
  summarise(annual_biomass = mean(total_biomass)) %>% 
  ggplot()+
  geom_line(aes(x = est_year, y = annual_biomass)) + #fill = "#07a3b7") +
  scale_fill_gmri(palette = "main") +
  theme_gmri() +
  ggtitle("Annual mean surveyed biomass") +
  ylab("Biomass (kg)") +
  xlab("Year")


```

### Leading and trailing edges

```{r}
#| label: edges
#| echo: false
#| message: false
#| warning: false
#| fig-align: center

clean_survey %>% 
  filter(comname == "black sea bass" & est_year >= 1970) %>%
  group_by(est_year) %>%  
  summarise(
    `10%`  = Hmisc::wtd.quantile(decdeg_beglat, weights = biomass_kg, probs = 0.10, na.rm = T),
    `90%`  = Hmisc::wtd.quantile(decdeg_beglat, weights = biomass_kg, probs = 0.90, na.rm = T)) %>% 
  pivot_longer(cols = 2:3, names_to = "quantile", values_to = "lat") %>% 
  left_join(
    clean_survey %>% 
      filter(est_year >= 1970) %>%
      group_by(est_year) %>%  
      summarise(
        `10%`  = Hmisc::wtd.quantile(decdeg_beglon, weights = biomass_kg, probs = 0.10, na.rm = T),
        `90%`  = Hmisc::wtd.quantile(decdeg_beglon, weights = biomass_kg, probs = 0.90, na.rm = T)) %>%
     pivot_longer(cols = 2:3, names_to = "quantile", values_to = "lon")
  ) -> quantiles

quantiles %>% 
  group_by(quantile) %>% 
   mutate(rmean_lat = zoo::rollapplyr(lat, width = 5, FUN = mean, align = "center", partial = T),
          rmean_lon = zoo::rollapplyr(lon, width = 5, FUN = mean, align = "center", partial = T)) %>%
  mutate(across(where(is.numeric), round, 4)) -> quantiles

ggplot(quantiles) +
  geom_line( aes(x = est_year, y = rmean_lat, color = quantile)) +
  geom_smooth(aes(x = est_year, y = rmean_lat, color = quantile), method = "lm", linetype = 2, linewidth = 0.5) +
  scale_color_gmri()+
  theme_gmri(plot.subtitle = element_text(size = 10)) +
  ggtitle("Leading and trailing edge", subtitle = "5-year rolling mean latitude") +
  xlab("Year") + ylab("Latitude") +
  guides(col = guide_legend(title = "Percentile"))

# Map
# us <- ne_states(country = "united states of america", returnclass = "sf")
#
# review lindsey's quantile plots 
```

## Landings

### Federally reported landings

Dealer data provided by Greater Atlantic Regional Fisheries Office

```{r}
#| label: landings 
#| echo: false
#| message: false
#| warning: false
#| fig-align: center
#| fig-width: 11
#| fig-height: 9

landings$coast <- factor(landings$STATE, levels = c("ME", "NH", "MA", "RI", "CT", "NY", "NJ", "DE", "MD", "VA", "NC" ))

landings %>%
  group_by(STATE, YEAR, coast) %>% 
  summarise(total_volume = sum(LANDED.LBS)/1000000) %>%
  ggplot() +
  geom_col(aes(x = YEAR, y = total_volume), fill = "#07a3b7", alpha = 0.7) +
  facet_wrap(~coast, ncol = 3, scales = "free_y") +
  ylim(c(0,NA)) +
  ggtitle("Landed volume") +
  ylab("Total landings (million lbs)") +
  xlab("Year") +
  theme_gmri(strip.background = element_rect(fill = "transparent"),
              strip.text = element_text(color = "black")) 

landings %>%
  group_by(STATE, YEAR, coast) %>% 
  summarise(total_value = sum(VALUE)/1000000) %>%
  ggplot() +
  geom_line(aes(x = YEAR, y = total_value), color = "#057872") +
  facet_wrap(~coast, ncol = 3, scales = "free_y") +
  ylim(c(0, NA)) +
  ggtitle("Landed value") +
  ylab("Total landings (million $USD)") +
  xlab("Year") +
  theme_gmri(strip.background = element_rect(fill = "transparent"),
              strip.text = element_text(color = "black")) 

```

```{r}
#| label: totals
#| echo: false
#| message: false 
#| warning: false
#| fig-align: center
#| fig-height: 5
#| fig-width: 7
landings %>%
  group_by(YEAR) %>% 
  summarise(mean_volume = mean(LANDED.LBS)/1000000) %>%
  ggplot() +
  geom_col(aes(x = YEAR, y = mean_volume), fill = "#07a3b7", alpha = 0.7) + 
  geom_smooth(aes(x = YEAR, y = mean_volume), method = "lm", se = FALSE, linewidth = 1, color = "#535353", alpha = 0.8) +
  theme_gmri() +
  ggtitle("Average landed volume", subtitle = "Across all ports") +
  xlab("Year") + ylab("Landed pounds (million)") -> mean

landings %>%
  group_by(YEAR) %>% 
  summarise(total_volume = sum(LANDED.LBS)/1000000) %>%
  ggplot() +
  geom_col(aes(x = YEAR, y = total_volume), fill = "#07a3b7", alpha = 0.7) + 
  geom_smooth(aes(x = YEAR, y = total_volume), method = "lm", se = FALSE, linewidth = 1, color = "#535353", alpha = 0.8) +
  theme_gmri() + 
  ggtitle("Total landed volume", subtitle = "Across all ports") +
  xlab("Year") + ylab("Landed pounds (million)") -> total


patchwork::wrap_plots(total, mean, ncol = 2)

```

### Ex-vessel price of black sea bass

Despite a general upward trend in landed volume and value, the price per pound has dropped significantly in all regions.

```{r}
#| label: ex-vessel price
#| echo: false
#| message: false
#| warning: false
#| fig-align: center

ex_vessel <- landings %>% 
  mutate(EX.VESSEL = LANDED.LBS/VALUE) 

ex_vessel %>% 
  group_by(STATE, YEAR) %>% 
  summarise(AVG.EX.VESSEL = mean(EX.VESSEL)) %>% 
  filter(!STATE == "ME") %>% # major outlier
  ggplot() + 
  geom_line(aes(x = YEAR, y = AVG.EX.VESSEL, color = STATE)) +
  ggtitle("Average ex-vessel price") + 
  xlab("Year") + ylab("Price per pound (USD)") + 
  theme_gmri() +
  scale_color_gmri()  

s_and_d <- ex_vessel %>% 
  group_by(YEAR) %>%
  summarise(AVG.LANDED.LBS = mean(LANDED.LBS/100000),
            AVG.EX.VESSEL  = mean(EX.VESSEL))
```
## Concentration of landings
The concentration of landings are weighted mean of latitude and longitude weighted by landed pounds. The majority of black sea bass landings are concentrated in southeastern New Jersey. 
```{r}
#| label: concentrations
#| echo: false
#| message: false
#| warning: false
#| fig-align: center

world <- ne_states(country = "united states of america", returnclass = "sf")

geocodes <- read.csv(here("Data", "ports.geocoded.csv")) %>% 
  rename("PORT.NAME" = "PORT") %>% 
  select(PORT.NAME, STATE, lon, lat)

landings %>% 
  left_join(geocodes) -> landings

landings_conc <- landings %>% 
  group_by(YEAR) %>% 
  summarise(
    avg_lat = weightedMean(lat, w = LANDED.LBS, na.rm = T), # maybe not
    avg_lon = weightedMean(lon, w = LANDED.LBS, na.rm = T)
  ) %>% 
  filter(YEAR >= 1996) %>% 
  mutate(avg_lat = round(avg_lat, digits = 1),
         avg_lon = round(avg_lon, digits = 1)) 

ggplot(landings_conc) +
  geom_line(aes(x = YEAR, y = avg_lat)) +
  ylim(c(36, 45)) +
  ggtitle("Concentration of landings", subtitle = "Since limited entry access") +
  xlab("Year") + ylab("Latitude") +
  theme_gmri()

```
## Licensing

### Federal Licenses

There are two categories of federally issued black sea bass licenses.

-   **Category** 1: Commercial (moratorim)

    -   *Commercial (moratorium) permits have been managed under a limited entry system since 1996; no new moratorium permits are being issued.*

-   **Category 2**: Recreational charter/party

Given our focus on commercial harvest, we will focus only on **Category** 1.

```{r}
#| label: federal licenses
#| echo: false
#| message: false
#| warning: false
#| fig-align: center
#| fig-width: 11
#| fig-height: 9

# arrange north to south

fed_license$states <- factor(fed_license$PPST, levels = c("ME", "NH", "MA", "RI", "CT", "NY", "NJ", "DE", "MD", "VA", "NC" ))

fed_license %>% 
  group_by(PPST, AP_YEAR, states) %>% 
  filter(!PPST %in% c("FL", "GA", "PA", "WA")) %>% 
  summarise(total_count = sum(count)) %>%
  ggplot() +
  geom_col(aes(x = AP_YEAR, y = total_count), fill = gmri_cols("seafood purple")) +
  facet_wrap(~states, scales = "free_y", ncol = 3) +
  ggtitle("Commercial harvest licenses") +
  xlab("Year") + ylab("Total issued") +
  scale_fill_gmri() +
  theme_gmri(strip.background = element_rect(fill = "transparent"),
              strip.text = element_text(color = "black")) 

## Check that 646 licenses were issued in 2017 (re the noaa fisheries site)

# fed_license %>% 
#   filter(!PPST %in% c("FL", "GA", "PA", "WA")) %>% 
#   group_by(AP_YEAR) %>% 
#   summarise(total_count = sum(count)) # 669, figure this out

```

*If Commercial black sea pass permits have been under limited entry since 1996, why are there increases in the number of permits held in some years. Should they all be declining? Are some transferring across state lines*

Given that licenses are attached to a vessel (and potentially other license types?) and we are reporting location based on principal ports, we cannot definitely say that black sea bass licenses are increasing/decreasing in certain states. We can, however, say that the number of vessels that hold bsb licenses are landing more/less in a particular state. 

```{r}
#| label: bsb vessels
#| echo: false
#| message: false
#| warning: false

bsb_vessels <- garfo_clean %>% 
  filter(BLACK_SEA_BASS_1 == 1) %>% 
  pivot_longer(cols = BLACK_SEA_BASS_1:TILEFISH_D, names_to = "license", values_to = "count") %>%
  filter(!count == 0) %>% 
  arrange(VP_NUM) %>% 
  left_join(garfo_licenses)

## Adjacency matrix? 
# bsb_adjacency <- garfo_clean %>% 
#   filter(BLACK_SEA_BASS_1 == 1) %>% 
#   select(BLACK_SEA_BASS_1:TILEFISH_D)
# 
# bsb_adjacency <- crossprod(as.matrix(bsb_adjacency))

# library(chorddiag)
# 
# palette <- c("#773891", "#535353", "#363b45", "#004966", "#00608a", "#07a3b7", "#057872", "#38431d", "#abb400", "#ebcb27", "#ea4f12", "#b94a40")
# 
# chorddiag(data = as.matrix(bsb_adjacency),
#           type = "directional",
#           showTicks = FALSE,
#           groupPadding = 5,
#           groupColors = palette,
#           chordedgeColor = palette,
#           groupnameFontsize = 12)

```



